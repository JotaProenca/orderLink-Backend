-- This migration creates SQL Server-specific objects for the database.
-- Ensure the database is SQL Server, as these scripts are not compatible with MySQL.

BEGIN TRY
    BEGIN TRANSACTION;

    -- Enable CLR integration if not already enabled
    IF NOT EXISTS
    (
        SELECT 1
        FROM sys.configurations
        WHERE name = 'clr enabled'
              AND value_in_use = 1
    )
        BEGIN
            EXEC sp_configure 
                 'clr enabled', 
                 1;
            RECONFIGURE;
    END;

    -- Create Assembly: RegexFunction (Placeholder)
    IF NOT EXISTS
    (
        SELECT 1
        FROM sys.assemblies
        WHERE name = 'RegexFunction'
    )
        BEGIN
            CREATE ASSEMBLY [RegexFunction] FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C0103007AC7B2490000000000000000E0000E210B010800002000000006000000000000AE3F0000002000000040000000004000002000000002000004000000000000000400000000000000008000000002000000000000020040050000100000100000000010000010000000000000100000000000000000000000603F00004B00000000400000B002000000000000000000000000000000000000006000000C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000B41F0000002000000020000000020000000000000000000000000000200000602E72737263000000B0020000004000000004000000220000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000002600000000000000000000000000004000004200000000000000000000000000000000903F0000000000004800000002000500042600005C19000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001E02280100000A2A1E02280400000A2AA6730600000A8001000004730700000A8002000004730800000A8003000004730900000A80040000042A0000133001000F000000010000117E010000046F0A00000A0A2B00062A00133001000F000000020000117E020000046F0B00000A0A2B00062A00133001000F000000030000117E030000046F0C00000A0A2B00062A00133001000F000000040000117E040000046F0D00000A0A2B00062A001330020011000000050000110203281100000A281200000A0A2B00062A000000133001000B0000000600001102281300000A0A2B00062A00133001000F00000007000011D005000002281400000A0A2B00062A00133001000B0000000800001102281500000A0A2B00062A00133001001800000009000011028C0100001B2D0A280100002B0A2B062B04020A2B00062A13300200100000000A000011031200FE150200001B06810200001B2A1E02281700000A2A133002002C0000000B000011027B1900000A6F1A00000A0B078C0300001B2D12280200002B0B027B1900000A076F1B00000A070A2B00062A4A02281700000A02731C00000A7D1900000A2A001E02281700000A2A133004001C0100000C0000110F00281E00000A178C17000001168C17000001281F00000A0F01281E00000A188C17000001168C17000001281F00000A282000000A0F02281E00000A1A8C17000001168C17000001281F00000A282000000A0F03281E00000A1E8C17000001168C17000001281F00000A282000000A0F04281E00000A1F108C17000001168C17000001281F00000A282000000A0F05281E00000A1F208C17000001168C17000001281F00000A282000000A0F06281E00000A1F408C17000001168C17000001281F00000A282000000A0F07281E00000A20000100008C17000001168C17000001281F00000A282000000A0F08281E00000A20000200008C17000001168C17000001281F00000A282000000A282100000A0B07282200000A0A2B00062A13300300510000000D0000110F01282300000A2D090F00282300000A2C0D7E2400000A282500000A0A2B301201FE151700000104282600000A0B0F01282700000A0F00282700000A07282800000A6F2900000A282500000A0A2B00062A00000013300300470000000E0000110F01282300000A2D090F00282300000A2C087E2A00000A0A2B2B1201FE151700000104282600000A0B0F01282700000A0F00282700000A07282B00000A282C00000A0A2B00062A00133003004D0000000F0000110F01282300000A2D090F00282300000A2C0916282200000A0A2B301201FE151700000104282600000A0B0F01282700000A0F00282700000A07282800000A6F2D00000A282200000A0A2B00062A000000133001002C000000100000110F00282300000A2C0D7E2400000A282500000A0A2B140F00282700000A282E00000A282500000A0A2B00062A133003003E000000110000110F01282300000A2D090F00282300000A2C04140B2B261200FE151700000104282600000A0A0F01282700000A0F00282700000A06282F00000A0B2B00072A0000360302283000000A283100000A2A00001330050042000000120000110F00282300000A2D090F01282300000A2C087E3200000A0A2B2612010F00282700000A0F01282700000A0F02282700000A19283300000A283100000A070A2B00062A00001330050051000000130000110F01282300000A2D090F00282300000A2C087E3200000A0B2B351200FE151700000105282600000A0A12020F01282700000A0F00282700000A0F02282700000A06283300000A283100000A080B2B00072A000000133003003E000000140000110F01282300000A2D090F00282300000A2C04140A2B261201FE151700000104282600000A0B0F01282700000A0F00282700000A07283400000A0A2B00062A0000133002002C0000001500001102741D0000010A03066F2900000A283100000A04066F2D00000A283500000A05066F3600000A283500000A2A42534A4201000100000000000C00000076322E302E35303732370000000005006C000000C0070000237E00002C080000DC07000023537472696E67730000000008100000080000002355530010100000100000002347554944000000201000003C09000023426C6F6200000000000000020000015715A209090E000000FA013300160000010000002300000007000000050000001C000000290000003A0000002F000000150000000200000005000000050000000900000001000000040000000200000003000000020000000000C9070100000000000A00D400AA000A000801EA000600180111010A007001AA000600EE0111010A00700246020E00B602A1020E00BF02A1020E005A03A1020600BC03A90312005604400412006F04400412009C0484040600C604B3040A000505DE040A001D0513001200520535050600870567050600A50511010600C90511010A00E20513000600300611061200630644060A00700613000A008006DE040A009306DE040600C00611011200D90644061200DF0644061200E506440612001F0744060E005D07420706007207110606007F07670506009F07670500000000010000000000010001000000000029003700050001000100000000003A00370009000100020000011000450037000D0001000300050100004F0000000D0005000800050100005D0000000D0005000F0001000000780093000D000600110031003301200031005C012D0031007E013A003100A301470021007F0290005020000000000618E400130001005820000000000618E4001300010060200000000011181F01170001008C2000000000130826011B000100A8200000000013084C0128000100C420000000001308750135000100E020000000001308930142000100FC20000000004602D901630001001C21000000004602E201680002003421000000008300F3016C0002005021000000004602FB017100020068210000000011000402780002008C21000000000100220280000300A821000000000618E40013000400B02100000000030836028B000400E821000000000618E40013000400FC21000000000618E400130004000422000000001600CA029D0004002C230000000016006403B4000D008C230000000016008503BF001000E0230000000016009203CA0013003C240000000016009D03D50016007424000000001600C803DC001700C024000000001100D303E7001A00D024000000001600E603EF001C002025000000001600FF03FA001F0080250000000016000D04DC002300CC250000000011001A040701260000000100E00100000100190200000100190200000100E10200000200EC0200000300F602000004000603000005000F03000006001A03000007003203000008003E03000009004903000001006F03000002007703000003007D03000001006F03000002007703000003007D03000001006F03000002007703000003007D03000001007703000001006F03000002007703000003007D0300000100770302000200E003000001007703000002006F0300000300F303000001006F0300000200770300000300F303000004007D03000001006F03000002007703000003007D0300000100770302000200E0030200030029040200040034040900E40013005900E40015016900E40024011100E40013007100E40013002400E40013002C00E40013003400E40013003C00E4001300240036028B002C0036028B00340036028B003C0036028B007900E40013008100E40013008900E400770191009605C2011900D90163001900E20168002900B705CF011900FB017100A100D305DF011900E4001300A900E400EF0144007F0290004C00FD058B004C0007066C024C00E4001300B100E40079024100FD058402C1007C068802C9008A068F02D1009F0695023900A9069A024900B5068402D900C706A6024900A906A9023900CD06AF024900FD057100E100DF06B502F100FD0571004100ED06C502E100F306C9024100A906D102F100FB066800E1000507E502E1000C07EF02D100FB01FF024900E4007701490012070403E10017070803E1002F0721033900E4003103F100370768000101E40013000901E40013001101E40031031901E4001300290083007C012E00D3011C092E00CB01130940002B004201400013001B01430013001B0143001B002A01490083008D0163001B002A01630013001B0169008300A10180002B00420183007300420183001B002A0183007B00420189008300AE01A0002B004201A300C300F701A30013001B01C0002B004201C30013001B01C300EB007E02E0002B004201000113001B0100012B00420120012B004201200113001B0140012B004201400113001B0160012B004201600113001B0180012B004201A0012B004201C00113001B01C0012B004201E0012B004201000213001B0100022B0042014002BB013B036002BB013B038002BB013B03A002BB013B03C002BB013B03E002BB0160032003BB01DB044003BB0137066003BB019407630168016D017201C701CB01D601DB01EA01EA017202A002BE02D702DE02EA02F802110318032A0336030400010006000500000008014F000000C10154000000700159000000CD015E0000008902980002000400030002000500050002000600070002000700090002000F000B0075007500880047014E0155015C0159026002048000000000000000000000000000000000BD07000002000000000000000000000001000A00000000000800000000000000000000000A00130000000000020000000000000000000000010095020000000002000000000000000000000001001101000000000500040006000400000010000C0017020000100019001702000000001B0017022D00E5012D0067020000003C4D6F64756C653E006D73636F726C6962004D6963726F736F66742E56697375616C4261736963004D794170706C69636174696F6E004D79004D79436F6D7075746572004D7950726F6A656374004D79576562536572766963657300546872656164536166654F626A65637450726F7669646572603100526567756C617245787072657373696F6E46756E6374696F6E730053696D706C6554616C6B2E5068696C2E466163746F72004D6963726F736F66742E56697375616C42617369632E4170706C69636174696F6E5365727669636573004170706C69636174696F6E42617365002E63746F72004D6963726F736F66742E56697375616C42617369632E4465766963657300436F6D70757465720053797374656D004F626A656374002E6363746F72006765745F436F6D7075746572006D5F436F6D70757465724F626A65637450726F7669646572006765745F4170706C69636174696F6E006D5F4170704F626A65637450726F76696465720055736572006765745F55736572006D5F557365724F626A65637450726F7669646572006765745F5765625365727669636573006D5F4D7957656253657276696365734F626A65637450726F7669646572004170706C69636174696F6E00576562536572766963657300457175616C73006F0047657448617368436F64650054797065004765745479706500546F537472696E67004372656174655F5F496E7374616E63655F5F005400696E7374616E636500446973706F73655F5F496E7374616E63655F5F006765745F476574496E7374616E6365004D6963726F736F66742E56697375616C42617369632E4D7953657276696365732E496E7465726E616C00436F6E7465787456616C75656031006D5F436F6E7465787400476574496E7374616E63650053797374656D2E446174610053797374656D2E446174612E53716C54797065730053716C496E7433320053716C426F6F6C65616E0052656745784F7074696F6E456E756D65726174696F6E0049676E6F726543617365004D756C74694C696E65004578706C696369744361707475726500436F6D70696C65640053696E676C654C696E650049676E6F72655061747465726E57686974657370616365005269676874546F4C6566740045434D415363726970740043756C74757265496E76617269616E740053716C537472696E670052656745784D61746368007061747465726E00696E707574004F7074696F6E7300526567457849734D61746368005265674578496E6465780052656745784573636170650053797374656D2E436F6C6C656374696F6E730049456E756D657261626C6500526567457853706C6974004E65787453706C6974526F77006D617463680052656745785265706C616365007265706C6163656D656E740052656745785265706C616365780052656745784D617463686573004E6578744D617463686564526F77006D61746368496E646578006D617463684C656E6774680053797374656D2E436F6D706F6E656E744D6F64656C00456469746F7242726F777361626C6541747472696275746500456469746F7242726F777361626C6553746174650053797374656D2E436F6465446F6D2E436F6D70696C65720047656E657261746564436F64654174747269627574650053797374656D2E446961676E6F737469637300446562756767657248696464656E417474726962757465004D6963726F736F66742E56697375616C42617369632E436F6D70696C65725365727669636573005374616E646172644D6F64756C6541747472696275746500486964654D6F64756C654E616D654174747269627574650053797374656D2E436F6D706F6E656E744D6F64656C2E44657369676E0048656C704B6579776F72644174747269627574650053797374656D2E52756E74696D652E436F6D70696C657253657276696365730052756E74696D6548656C70657273004765744F626A65637456616C75650052756E74696D655479706548616E646C65004765745479706546726F6D48616E646C6500416374697661746F7200437265617465496E7374616E6365004D7947726F7570436F6C6C656374696F6E417474726962757465006765745F56616C7565007365745F56616C75650053797374656D2E52756E74696D652E496E7465726F70536572766963657300436F6D56697369626C654174747269627574650053797374656D2E546578742E526567756C617245787072657373696F6E730052656765784F7074696F6E7300496E746572616374696F6E00494966004F70657261746F7273004F724F626A65637400436F6E76657273696F6E7300546F496E7465676572006F705F496D706C69636974006765745F49734E756C6C00537472696E6700456D707479006F705F4578706C69636974005265676578004D6174636800436170747572650046616C73650049734D61746368006765745F496E646578004573636170650053706C6974004E756C6C005265706C616365004D61746368436F6C6C656374696F6E004D617463686573006765745F4C656E677468004D6963726F736F66742E53716C5365727665722E5365727665720053716C46756E6374696F6E417474726962757465004F757441747472696275746500436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C69747941747472696275746500526567657853514C434C5200526567657853514C434C522E646C6C00000000000320000000000039F3ABCF6E186542A7009EFA3A571F530008B77A5C561934E08908B03F5F7F11D50A3A0320000103000001040000120C070615121801120C040000120807061512180112080400001211070615121801121104000012140706151218011214040800120C040800120804080012110408001214042001021C0320000804200012150320000E021E00071001011E001E000730010101101E00021300042000130007061512190113000428001300160009111D1121112111211121112111211121112111210A0003112511251125111D0A0003112111251125111D0A0003111D11251125111D060001112511250A0003122911251125111D070002011C1011250A000311251125112511250C00041125112511251125111D0D0004011C10112510111D10111D052001011131080100010000000000052002010E0E1701000A4D7954656D706C61746507382E302E302E30000004010000000615121801120C061512180112080615121801121106151218011214040701120C040701120804070112110407011214042001010E1001000B4D792E436F6D707574657200001301000E4D792E4170706C69636174696F6E00000C0100074D792E5573657200001301000E4D792E576562536572766963657300000400011C1C03070102030701080600011215114D04070112150307010E051001001E00040A011E000407011E00072004010E0E0E0E6101003453797374656D2E5765622E53657276696365732E50726F746F636F6C732E536F617048747470436C69656E7450726F746F636F6C124372656174655F5F496E7374616E63655F5F13446973706F73655F5F496E7374616E63655F5F0000000615121801130006151219011300040A011300052001011300060702130013000420010102050100000000032000020600031C021C1C0500021C1C1C040001081C050001111D08050702111D0802060E05000111250E05000108111D08000312750E0E115D0607021125115D03061121070003020E0E115D0500011121020607021121115D060702111D115D0400010E0E04070111250800031D0E0E0E115D060702115D12290400010E1C030611250800040E0E0E0E115D06070211251125080703115D11251125080003127D0E0E115D0607021229115D04200101080407011275240100020054020F497344657465726D696E697374696301540209497350726563697365018179010006005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E69737469630154020949735072656369736501540E044E616D650A526567457853706C697454557F4D6963726F736F66742E53716C5365727665722E5365727665722E53797374656D446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038391053797374656D4461746141636365737300000000540E1146696C6C526F774D6574686F644E616D650C4E65787453706C6974526F77815A010005005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E69737469630154020949735072656369736501540E044E616D650C52656745785265706C61636554557F4D6963726F736F66742E53716C5365727665722E5365727665722E53797374656D446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038391053797374656D4461746141636365737300000000815B010005005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E69737469630154020949735072656369736501540E044E616D650D52656745785265706C6163657854557F4D6963726F736F66742E53716C5365727665722E5365727665722E53797374656D446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038391053797374656D4461746141636365737300000000817D010006005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E69737469630154020949735072656369736501540E044E616D650C52656745784D61746368657354557F4D6963726F736F66742E53716C5365727665722E5365727665722E53797374656D446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038391053797374656D4461746141636365737300000000540E1146696C6C526F774D6574686F644E616D650E4E6578744D617463686564526F770801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F77730100883F000000000000000000009E3F0000002000000000000000000000000000000000000000000000903F00000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF25002040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000540200000000000000000000540234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004B4010000010053007400720069006E006700460069006C00650049006E0066006F0000009001000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E003000000040001000010049006E007400650072006E0061006C004E0061006D006500000052006500670065007800530051004C0043004C0052002E0064006C006C0000002800020001004C006500670061006C0043006F0070007900720069006700680074000000200000004800100001004F0072006900670069006E0061006C00460069006C0065006E0061006D006500000052006500670065007800530051004C0043004C0052002E0064006C006C000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000C000000B03F00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 WITH PERMISSION_SET = SAFE;
    END;

    -- Create Function: RegExReplaceX
    SET ANSI_NULLS OFF;
    SET QUOTED_IDENTIFIER OFF;
    GO;
    IF OBJECT_ID('[dbo].[RegExReplaceX]', 'FN') IS NULL
        EXEC ('CREATE FUNCTION [dbo].[RegExReplaceX]() RETURNS NVARCHAR(MAX) AS BEGIN RETURN NULL; END');
    GO;
    ALTER FUNCTION [dbo].[RegExReplaceX](@Pattern    [NVARCHAR](4000), 
                                         @Input      [NVARCHAR](MAX), 
                                         @Repacement [NVARCHAR](MAX), 
                                         @Options    [INT])
    RETURNS [NVARCHAR](MAX)
    WITH EXECUTE AS CALLER
    AS
         EXTERNAL NAME
    [RegexFunction].[SimpleTalk.Phil.Factor.RegularExpressionFunctions].[RegExReplacex];
    GO;

    -- Create Stored Procedure: SP_HELPTEXT_SIG
    SET ANSI_NULLS ON;
    SET QUOTED_IDENTIFIER ON;
    GO;
    IF OBJECT_ID('[dbo].[SP_HELPTEXT_SIG]', 'P') IS NULL
        EXEC ('CREATE PROC [dbo].[SP_HELPTEXT_SIG] AS RETURN 0;');
    GO;
    ALTER PROCEDURE [dbo].[SP_HELPTEXT_SIG] @ObjectName SYSNAME, 
                                            @ColumnName SYSNAME = NULL, 
                                            @Html       BIT     = 0,

                                            /* Indica retorno via rel dinâmico/qmf */

                                            @Xml        BIT     = 0

    /* Utilizar em casos de quebra de linha no meio da procedure*/

    AS
         SET NOCOUNT ON;
         SET ARITHABORT, ANSI_NULL_DFLT_ON, ANSI_WARNINGS, ANSI_PADDING, CONCAT_NULL_YIELDS_NULL ON;
         DECLARE @Parent_Name SYSNAME, @SchemaName SYSNAME, @Object_Id INT, @Enter CHAR(2)= CHAR(13) + CHAR(10);
         IF CHARINDEX(',', @ObjectName) > 1
             SELECT @ObjectName = RTRIM(LTRIM(LEFT(@ObjectName, CHARINDEX(',', @ObjectName) - 1)));
         SELECT @Object_Id = OBJECT_ID(@ObjectName);
         IF @Object_Id IS NULL
             SELECT @Object_Id = t.[object_id]
             FROM sys.triggers t
             WHERE t.[name] = @ObjectName;
             ELSE
             BEGIN
                 SELECT @ObjectName = OBJECT_NAME(@Object_Id);
                 SELECT @SchemaName = OBJECT_SCHEMA_NAME(@Object_Id);
         END;
         DECLARE @Type VARCHAR(2);
         WITH Temp_Objects
              AS (SELECT t.[object_id], 
                         t.[name], 
                         t.[type], 
                         t.parent_id
                  FROM sys.triggers t
                  UNION
                  SELECT o.[object_id], 
                         o.[name], 
                         o.[type], 
                         o.parent_object_id
                  FROM sys.objects o)
              SELECT @ObjectName = [name], 
                     @Type = [type], 
                     @Parent_Name = OBJECT_NAME([parent_id])
              FROM Temp_Objects
              WHERE [object_id] = @Object_Id;
         IF @@RowCount = 0
             BEGIN
                 DECLARE @Msg VARCHAR(150)= @ObjectName + ' não existe';
                 RAISERROR(@Msg, 16, 1);
                 RETURN;
         END;
         Html_Return:
         IF @Html = 1
            OR EXISTS
         (
             SELECT 1
             FROM sys.dm_exec_sessions s
             WHERE s.session_id = @@spid
                   AND s.client_interface_name = 'ODBC'
         )
             BEGIN
                 SELECT [text] = '<div style="text-align: left;"><pre><xmp>' + T.c + '</xmp></pre></div>'
                 FROM sys.sql_modules sm
                      CROSS APPLY
                 (
                     SELECT 'Set Ansi_Nulls ' + CASE uses_ansi_nulls
                                                    WHEN 1
                                                    THEN 'On '
                                                    ELSE 'Off'
                                                END + @Enter + 'Set Quoted_Identifier ' + CASE uses_quoted_identifier
                                                                                              WHEN 1
                                                                                              THEN 'On'
                                                                                              ELSE 'Off'
                                                                                          END + @Enter + 'Go' + @Enter + dbo.RegExReplaceX('Create(\s+Or\s+Alter)?\s+(Procedure|Proc|Trigger|View|Function)\s+(\[?\w+\]?\.)?(\[?' + ISNULL(OBJECT_NAME(sm.[object_id]), @ObjectName) + '\]?)', sm.[definition], 'Alter $2 ' + ISNULL(QUOTENAME(OBJECT_SCHEMA_NAME(sm.[object_id])) + '.', '') + QUOTENAME(ISNULL(OBJECT_NAME(sm.[object_id]), @ObjectName)), 521)
                 ) T(c)
                 WHERE sm.[object_id] = @Object_Id;
                 RETURN;
         END;
         Xml_Return:
         IF @Xml = 1
             BEGIN
                 SELECT [object_id] = @Object_Id, 
                        [name] = @ObjectName, 
                        [text] = CAST(Fmt.c AS XML)
                 FROM sys.sql_modules sm
                      CROSS APPLY
                 (
                     SELECT 'Set Ansi_Nulls ' + CASE uses_ansi_nulls
                                                    WHEN 1
                                                    THEN 'On '
                                                    ELSE 'Off'
                                                END + @Enter + 'Set Quoted_Identifier ' + CASE uses_quoted_identifier
                                                                                              WHEN 1
                                                                                              THEN 'On'
                                                                                              ELSE 'Off'
                                                                                          END + @Enter + 'Go' + @Enter + dbo.RegExReplaceX('Create(\s+Or\s+Alter)?\s+(Procedure|Proc|Trigger|View|Function)\s+(\[?\w+\]?\.)?(\[?' + ISNULL(OBJECT_NAME(sm.[object_id]), @ObjectName) + '\]?)', sm.[definition], 'Alter $2 ' + ISNULL(QUOTENAME(OBJECT_SCHEMA_NAME(sm.[object_id])) + '.', '') + QUOTENAME(ISNULL(OBJECT_NAME(sm.[object_id]), @ObjectName)), 521)
                 ) T(c)
                      CROSS APPLY
                 (
                     SELECT T.c AS [processing-instruction(x)] FOR XML PATH('')
                 ) Fmt(c)
                 WHERE sm.[object_id] = @Object_Id;
                 RETURN;
         END;
         IF @Type = 'TR'
            AND EXISTS
         (
             SELECT 1
             FROM sys.triggers t
             WHERE t.[object_id] = @Object_Id
                   AND t.parent_class_desc = 'DATABASE'
         )
             BEGIN
                 SET @Xml = 1;
                 GOTO Xml_Return;
         END;
         IF @Type = 'SN'
             BEGIN
                 DECLARE @synonym_definition NVARCHAR(1035), @synonym_name SYSNAME, @synonym_schema_name SYSNAME;
                 SELECT @synonym_definition = base_object_name, 
                        @synonym_schema_name = QUOTENAME(SCHEMA_NAME([schema_id])), 
                        @synonym_name = QUOTENAME([name])
                 FROM sys.synonyms
                 WHERE [object_id] = @Object_Id;
                 PRINT 'Create Synonym ' + @synonym_schema_name + '.' + @synonym_name + ' For ' + @synonym_definition + ';';
                 PRINT 'go';
                 RETURN;
         END;
         IF NOT @Object_Id > 0
             BEGIN
                 PRINT @ObjectName + ' não encontrado.';
                 RETURN;
         END;
         IF @Type = RTRIM(LTRIM('U'))
             BEGIN
                 EXEC SP_SCRIPT 
                      @ObjectName;
                 RETURN;
         END;
         DECLARE @Properties VARCHAR(100)= '';
         SELECT @Properties = 'Set Ansi_Nulls ' + CASE uses_ansi_nulls
                                                      WHEN 1
                                                      THEN 'On '
                                                      ELSE 'Off'
                                                  END + @Enter + 'Set Quoted_Identifier ' + CASE uses_quoted_identifier
                                                                                                WHEN 1
                                                                                                THEN 'On'
                                                                                                ELSE 'Off'
                                                                                            END + @Enter
         FROM sys.sql_modules
         WHERE [object_id] = @Object_Id;
         PRINT @Properties;
         PRINT 'go';
         IF ISNULL(@Type, '') = 'P'
             BEGIN
                 PRINT 'If Object_Id(''' + ISNULL(QUOTENAME(@SchemaName) + '.', '') + QUOTENAME(@ObjectName) + ''', ''P'') Is Null';
                 PRINT '    Exec (''Create Proc ' + ISNULL(QUOTENAME(@SchemaName) + '.', '') + QUOTENAME(@ObjectName) + ' As Return 0;'')';
         END;
         IF ISNULL(@Type, '') = 'V'
             BEGIN
                 PRINT 'If Object_Id(''' + ISNULL(QUOTENAME(@SchemaName) + '.', '') + QUOTENAME(@ObjectName) + ''', ''V'') Is Null';
                 PRINT '    Exec (''Create View ' + ISNULL(QUOTENAME(@SchemaName) + '.', '') + QUOTENAME(@ObjectName) + ' As Select A = Null;'')';
         END;
         IF ISNULL(@Type, '') = 'TR'
             BEGIN
                 PRINT 'If Object_Id(''' + ISNULL(QUOTENAME(@SchemaName) + '.', '') + QUOTENAME(@ObjectName) + ''', ''TR'') Is Null';
                 PRINT '    Exec (''Create Trigger ' + ISNULL(QUOTENAME(@SchemaName) + '.', '') + QUOTENAME(@ObjectName) + ' On ' + @Parent_Name + ' For Insert As Select A = Null;'')';
         END;
         IF ISNULL(@Type, '') IN('FN', 'IF', 'TF')
             BEGIN
                 PRINT 'If Object_Id(''' + ISNULL(QUOTENAME(@SchemaName) + '.', '') + QUOTENAME(@ObjectName) + ''', ''' + @Type + ''') Is Null';
                 IF ISNULL(@Type, '') = 'FN'
                     BEGIN
                         PRINT '    Exec (''Create Function ' + ISNULL(QUOTENAME(@SchemaName) + '.', '') + QUOTENAME(@ObjectName) + '() Returns Int As Begin Return 0; End'')';
                 END;
                 IF ISNULL(@Type, '') = 'IF'
                     BEGIN
                         PRINT '    Exec (''Create Function ' + ISNULL(QUOTENAME(@SchemaName) + '.', '') + QUOTENAME(@ObjectName) + '() Returns Table As Return Select A = Null;'')';
                 END;
                 IF ISNULL(@Type, '') = 'TF'
                     BEGIN
                         PRINT '    Exec (''Create Function ' + ISNULL(QUOTENAME(@SchemaName) + '.', '') + QUOTENAME(@ObjectName) + '() Returns @Results Table (Itens Int Null) As Begin Return; End'')';
                 END;
         END;
         PRINT 'go';
         DECLARE @dbname SYSNAME, @BlankSpaceAdded INT, @BasePos INT, @CurrentPos INT, @TextLength INT, @LineId INT, @AddOnLen INT, @LFCR INT --lengths of line feed carriage return
         , @DefinedLength INT, @SyscomText NVARCHAR(MAX), @Line NVARCHAR(MAX), @texttemp NVARCHAR(MAX), @Count_Lines INT;
         SELECT @DefinedLength = 1000;
         SELECT @BlankSpaceAdded = 0;

         /*Keeps track of blank spaces at End of lines. Note Len function ignores trailing blank spaces*/

         CREATE TABLE #CommentText
         (LineId INT, 
          Text   NVARCHAR(MAX) COLLATE database_default, 
          Size   INT NULL
         );
         SELECT @dbname = PARSENAME(@ObjectName, 3);
         IF @dbname IS NOT NULL
            AND @dbname <> DB_NAME()
             BEGIN
                 RAISERROR(15250, -1, -1);
                 RETURN(1);
         END;
         IF(ISNULL(@Object_Id, 0) = 0)
             BEGIN
                 SELECT @dbname = DB_NAME();
                 RAISERROR(15009, -1, -1, @ObjectName, @dbname);
                 RETURN(1);
         END;
         INSERT INTO #CommentText
                SELECT Id, 
                       Item, 
                       LEN(Item)
                FROM dbo.Split_Xml
                (
                (
                    SELECT definition
                    FROM sys.sql_modules
                    WHERE Object_id = @Object_id
                ), @Enter
                );
         SET @Count_Lines = @@ROWCOUNT;
         IF EXISTS
         (
             SELECT *
             FROM #CommentText
             WHERE Size > 16000
         )
            AND EXISTS
         (
             SELECT 1
             FROM sys.dm_exec_sessions s
             WHERE s.session_id = @@spid
                   AND s.program_name LIKE 'Microsoft SQL Server Management Studio%'
         )
             BEGIN
                 SELECT 'Linha ultrapassa o limite para print no SSMS', 
                        *
                 FROM #CommentText
                 WHERE Size > 16000;
                 SET @Xml = 1;
                 GOTO Xml_Return;
         END;
         GOTO Jump_Old_Code;
         IF(@ColumnName IS NOT NULL)
             BEGIN
                 IF
                 (
                     SELECT COUNT(*)
                     FROM sys.objects o
                     WHERE o.object_id = @Object_Id
                           AND type IN('S ', 'U ', 'TF')
                 ) = 0
                     BEGIN
                         RAISERROR(15218, -1, -1, @ObjectName);
                         RETURN(1);
                 END;
                 IF(
                 (
                     SELECT 'Count' = COUNT(*)
                     FROM syscolumns c
                     WHERE name = @ColumnName
                           AND c.id = @Object_Id
                           AND c.number = 0
                 ) = 0)
                     BEGIN
                         RAISERROR(15645, -1, -1, @ColumnName);
                         RETURN(1);
                 END;
                 IF(
                 (
                     SELECT iscomputed
                     FROM syscolumns
                     WHERE name = @ColumnName
                           AND id = @Object_Id
                           AND number = 0
                 ) = 0)
                     BEGIN
                         RAISERROR(15646, -1, -1, @ColumnName);
                         RETURN(1);
                 END;
                 DECLARE ms_crs_syscom CURSOR FAST_FORWARD LOCAL
                 FOR SELECT Text
                     FROM syscomments
                     WHERE Id = @Object_Id
                           AND Encrypted = 0
                           AND Number =
                     (
                         SELECT ColId
                         FROM Syscolumns
                         WHERE Name = @ColumnName
                               AND Id = @Object_Id
                               AND Number = 0
                     )
                     ORDER BY Number, 
                              ColId;
         END;
             ELSE
             BEGIN
                 IF
                 (
                     SELECT COUNT(*)
                     FROM sys.sql_modules sm
                          LEFT JOIN sys.objects o ON sm.object_id = o.object_id
                     WHERE sm.object_id = @Object_Id
                           AND (o.type NOT IN('S', 'U')
                     OR o.type IS NULL)
                 ) = 0
                     BEGIN
                         RAISERROR(15197, -1, -1, @ObjectName);
                         RETURN(1);
                 END;
                 IF
                 (
                     SELECT COUNT(*)
                     FROM sys.sql_modules sm
                     WHERE sm.object_id = @Object_Id
                           AND sm.definition IS NOT NULL
                 ) = 0
                     BEGIN
                         RAISERROR(15471, -1, -1);
                         RETURN(0);
                 END;
                 DECLARE ms_crs_syscom CURSOR FAST_FORWARD LOCAL
                 FOR SELECT [definition]
                     FROM sys.sql_modules
                     WHERE [object_id] = @Object_Id
                           AND OBJECTPROPERTY([object_id], 'IsEncrypted') = 0;
         END;
         SELECT @LFCR = 2;
         SELECT @LineId = 1;
         OPEN ms_crs_syscom;
         FETCH NEXT FROM ms_crs_syscom INTO @SyscomText;
         WHILE @@Fetch_Status >= 0
             BEGIN
                 SELECT @BasePos = 1;
                 SELECT @CurrentPos = 1;
                 SELECT @TextLength = LEN(@SyscomText);
                 WHILE @CurrentPos != 0
                     BEGIN
                         SELECT @CurrentPos = CHARINDEX(CHAR(13) + CHAR(10), @SyscomText, @BasePos);
                         IF @CurrentPos != 0
                             BEGIN
                                 WHILE(ISNULL(LEN(@Line), 0) + @BlankSpaceAdded + @CurrentPos - @BasePos + @LFCR) > @DefinedLength
                                     BEGIN
                                         SELECT @AddOnLen = @DefinedLength - (ISNULL(LEN(@Line), 0) + @BlankSpaceAdded);
                                         INSERT INTO #CommentText
                                         (LineId, 
                                          Text
                                         )
                                         VALUES
                                         (@LineId, 
                                          ISNULL(@Line, N'') + ISNULL(SUBSTRING(@SyscomText, @BasePos, @AddOnLen), N'')
                                         );
                                         SELECT @Line = NULL, 
                                                @LineId = @LineId + 1, 
                                                @BasePos = @BasePos + @AddOnLen, 
                                                @BlankSpaceAdded = 0;
                         END;
                                 SELECT @Line = ISNULL(@Line, N'') + ISNULL(SUBSTRING(@SyscomText, @BasePos, @CurrentPos - @BasePos + @LFCR), N'');
                                 SELECT @BasePos = @CurrentPos + 2;
                                 INSERT INTO #CommentText
                                 (LineId, 
                                  Text
                                 )
                                 VALUES
                                 (@LineId, 
                                  @Line
                                 );
                                 SELECT @LineId+=1;
                                 SELECT @Line = NULL;
                         END;
                             ELSE
                             BEGIN
                                 IF @BasePos <= @TextLength
                                     BEGIN
                                         WHILE(ISNULL(LEN(@Line), 0) + @BlankSpaceAdded + @TextLength - @BasePos + 1) > @DefinedLength
                                             BEGIN
                                                 SELECT @AddOnLen = @DefinedLength - (ISNULL(LEN(@Line), 0) + @BlankSpaceAdded);
                                                 INSERT INTO #CommentText
                                                 (LineId, 
                                                  Text
                                                 )
                                                 VALUES
                                                 (@LineId, 
                                                  ISNULL(@Line, N'') + ISNULL(SUBSTRING(@SyscomText, @BasePos, @AddOnLen), N'')
                                                 );
                                                 SELECT @Line = NULL, 
                                                        @LineId = @LineId + 1, 
                                                        @BasePos = @BasePos + @AddOnLen, 
                                                        @BlankSpaceAdded = 0;
                                 END;
                                         SELECT @Line = ISNULL(@Line, N'') + ISNULL(SUBSTRING(@SyscomText, @BasePos, @TextLength - @BasePos + 1), N'');
                                         IF LEN(@Line) < @DefinedLength
                                            AND CHARINDEX(' ', @SyscomText, @TextLength + 1) > 0
                                             BEGIN
                                                 SELECT @Line = @Line + ' ', 
                                                        @BlankSpaceAdded = 1;
                                         END;
                                 END;
                         END;
                     END;
                 FETCH NEXT FROM ms_crs_syscom INTO @SyscomText;
             END;
         CLOSE ms_crs_syscom;
         DEALLOCATE ms_crs_syscom;
         Jump_Old_Code:
         UPDATE TOP (1) #CommentText
           SET 
               Text = Replace([Text], OBJECT_NAME(@Object_Id), LOWER(LEFT(OBJECT_NAME(@Object_Id), 1)) + dbo.udf_TitleCase(RIGHT(OBJECT_NAME(@Object_Id), LEN(OBJECT_NAME(@Object_Id)) - 1)))
         WHERE Text LIKE '%Alter View%' + @ObjectName + '%';
         UPDATE TOP (1) #CommentText
           SET 
               [Text] = dbo.RegExReplaceX('Create(\s+Or\s+Alter)?\s+(Procedure|Proc|Trigger|View|Function)\s+((\[?\w+\]?\.)?(\[)?' + @ObjectName + '(\])?)', [Text], 'Alter $2 ' + ISNULL(QUOTENAME(@SchemaName) + '.', '') + QUOTENAME(@ObjectName), 521)
         WHERE dbo.RegExIsMatch('Create(\s+Or\s+Alter)?\s+(Procedure|Proc|Trigger|View|Function)\s+((\[?\w+\]?\.)?(\[)?' + @ObjectName + '(\])?)', [Text], 521) = 1;
         DELETE FROM #CommentText
         WHERE LineId = @Count_Lines
               AND DATALENGTH([Text]) = 0;
         DECLARE @size INT;
         DECLARE sp_cur CURSOR LOCAL FAST_FORWARD
         FOR SELECT [Text], 
                    Size
             FROM #CommentText
             ORDER BY LineId;
         OPEN sp_cur;
         FETCH NEXT FROM sp_cur INTO @texttemp, @size;
         WHILE(@@fetch_status <> -1)
             BEGIN
                 IF @size > 4000
                     PRINT CAST(@texttemp AS NTEXT);
                     ELSE
                     IF @size = 0
                         PRINT @Enter;
                         ELSE
                         PRINT @texttemp;
                 FETCH NEXT FROM sp_cur INTO @texttemp, @size;
             END;
         CLOSE sp_cur;
         DEALLOCATE sp_cur;
         DROP TABLE #CommentText;
         PRINT 'go';
         IF ISNULL(@Type, '') = 'P'
             BEGIN
                 PRINT 'Grant Execute On ' + ISNULL(QUOTENAME(@SchemaName) + '.', '') + QUOTENAME(@ObjectName) + ' To [Sistema]';
                 PRINT 'go';
         END;
         IF ISNULL(@Type, '') = 'V'
             BEGIN
                 PRINT 'Grant Select,Insert,Update,Delete on ' + ISNULL(QUOTENAME(@SchemaName) + '.', '') + QUOTENAME(@ObjectName) + ' To [Sistema]';
                 PRINT 'go';
         END;
    GO;

    -- Create Stored Procedure: SP_SCRIPT
    SET ANSI_NULLS ON;
    SET QUOTED_IDENTIFIER ON;
    GO;
    IF OBJECT_ID('[dbo].[SP_SCRIPT]', 'P') IS NULL
        EXEC ('CREATE PROC [dbo].[SP_SCRIPT] AS RETURN 0;');
    GO;
    ALTER PROC [dbo].[SP_SCRIPT] @Table_Name  VARCHAR(150), 
                                 @Column      VARCHAR(50)  = NULL, 
                                 @Type_Script VARCHAR(3)   = 'C'
    AS
        BEGIN
            DECLARE @NumTypes NVARCHAR(80);
            DECLARE @StrTypes NVARCHAR(80);
            DECLARE @Column_Id INT;
            DECLARE @Column_Name VARCHAR(80);
            DECLARE @Type_Name VARCHAR(20);
            DECLARE @Max_Length INT;
            DECLARE @Precision INT;
            DECLARE @Scale INT;
            DECLARE @Collation_Name VARCHAR(80);
            DECLARE @Is_Null VARCHAR(150);
            DECLARE @Type_Aux VARCHAR(50);
            DECLARE @Definition VARCHAR(255);
            DECLARE @ObjId INT;
            DECLARE @Column_PK VARCHAR(50);
            DECLARE @Is_Nullable BIT;
            DECLARE @Is_Identity BIT;
            SELECT @NumTypes = N'decimal,real,money,numeric,smallmoney';
            SELECT @StrTypes = N'Varchar,char,nvarchar,nchar';
            SET @Table_Name = OBJECT_NAME(OBJECT_ID((LTRIM(RTRIM(@Table_Name)))));
            IF @Table_Name IS NULL
                BEGIN
                    PRINT 'Informe o nome da tabela ';
                    RETURN;
            END;
            IF NOT EXISTS
            (
                SELECT 1
                FROM sys.objects
                WHERE [type] = 'U'
                      AND [name] = @Table_Name
            )
                BEGIN
                    PRINT 'Não existe a tabela ' + @Table_Name;
                    RETURN;
            END;
            SET @ObjId = OBJECT_ID(@Table_Name);
            IF @Column IS NOT NULL
                BEGIN
                    SELECT @Column_Id = column_id
                    FROM sys.all_columns
                    WHERE [object_id] = OBJECT_ID(@Table_Name)
                          AND [Name] = RTRIM(LTRIM(@Column));
                    IF @Column_Id IS NULL
                        BEGIN
                            PRINT 'Não foi encontrada a coluna ' + @Column + ' para a tabela ' + @Table_Name;
                            RETURN;
                    END;
            END;
            PRINT '/************************************************************************/';
            PRINT '/************** Script de criação e modificação de colunas **************/';
            PRINT '/************** ' + SPACE(12) + CONVERT(VARCHAR, GETDATE(), 103) + SPACE(1) + CONVERT(VARCHAR, GETDATE(), 108) + SPACE(11) + ' **************/';
            PRINT '/************************************************************************/' + CHAR(13) + CHAR(10) + CHAR(13) + CHAR(10);
            IF @Type_Script = 'C'
                BEGIN
                    SELECT @Column_PK = INDEX_COL(OBJECT_NAME(o.parent_object_id), i.index_id, 1), 
                           @Type_Name = TYPE_NAME(c.user_type_id), 
                           @Is_Nullable = c.is_nullable, 
                           @Is_Identity = c.is_identity
                    FROM sys.objects O
                         INNER JOIN sys.indexes i ON i.[object_id] = O.parent_object_id
                                                     AND i.[name] = O.[name]
                         INNER JOIN sys.index_columns ic ON i.[object_id] = ic.[object_id]
                                                            AND i.index_id = ic.index_id
                         INNER JOIN sys.columns c ON c.[object_id] = ic.[object_id]
                                                     AND ic.column_id = c.column_id
                    WHERE O.parent_object_id = OBJECT_ID(@Table_Name)
                          AND O.[type] IN('PK');
                    IF ISNULL(@Column_PK, '') = ''
                        SELECT TOP 1 @Column_PK = c.[name], 
                                     @Type_Name = TYPE_NAME(c.user_type_id), 
                                     @Precision = c.[precision], 
                                     @Scale = c.scale, 
                                     @Max_Length = c.max_length, 
                                     @Is_Nullable = c.is_nullable, 
                                     @Is_Identity = c.is_identity
                        FROM sys.objects O
                             INNER JOIN sys.columns c ON o.[object_id] = c.[object_id]
                        WHERE O.[name] = @Table_Name
                        ORDER BY c.column_id;
                    IF CHARINDEX(@Type_Name, @NumTypes) > 0
                        SET @Type_Aux = '(' + CONVERT(VARCHAR, @Precision) + ',' + CONVERT(VARCHAR, @Scale) + ')';
                        ELSE
                        IF CHARINDEX(@Type_Name, @StrTypes) > 0
                            SET @Type_Aux = '(' + CONVERT(VARCHAR, Replace(@Max_Length, -1, 'Max')) + ')';
                    SET @Type_Aux = ISNULL(@Type_Aux, '');
                    PRINT 'If Object_Id(''' + @Table_Name + ''') Is Null';
                    PRINT '    Create Table [' + @Table_Name + '] ([' + @Column_PK + '] ' + @Type_Name + @Type_Aux + CASE @Is_Nullable
                                                                                                                         WHEN 0
                                                                                                                         THEN ' Not Null'
                                                                                                                         ELSE ' Null'
                                                                                                                     END + CASE @Is_Identity
                                                                                                                               WHEN 0
                                                                                                                               THEN ''
                                                                                                                               ELSE ' Identity(1,1)'
                                                                                                                           END + ')';
                    PRINT 'Go';
                    IF @Type_Name IS NULL
                        SELECT @Type_Name = TYPE_NAME(c.user_type_id)
                        FROM sys.columns c
                        WHERE c.[object_id] = OBJECT_ID(@Table_Name)
                              AND c.[name] = @Column_PK;
                    PRINT 'If Not ColumnProperty (Object_Id(''' + @Table_Name + ''') , ''' + @Column_PK + ''', ''AllowsNull'') = ' + CAST(@Is_Nullable AS VARCHAR) + ' Or Not Exists(Select * From sys.columns c Where c.[object_id] = Object_Id(''' + @Table_Name + ''') And c.[Name] = ''' + @Column_PK + ''' And Type_Name(c.system_type_id) = ''' + @Type_Name + '''' + ' And c.max_length = ' + CAST(@Max_Length AS VARCHAR) + ' And c.[precision] = ' + CAST(@Precision AS VARCHAR) + ' And c.scale = ' + CAST(@Scale AS VARCHAR) + ')';
                    PRINT '    Alter Table [' + @Table_Name + '] Alter Column [' + @Column_PK + '] ' + @Type_Name + @Type_Aux + CASE @Is_Nullable
                                                                                                                                    WHEN 0
                                                                                                                                    THEN ' Not Null'
                                                                                                                                    ELSE ' Null'
                                                                                                                                END;
                    PRINT 'Go';
            END;
            DECLARE @cnstdes NVARCHAR(4000), @cnstname SYSNAME, @i INT, @cnsttype CHARACTER(2), @keys NVARCHAR(2126), @dbname SYSNAME;
            DECLARE Colunas_cursor CURSOR STATIC FORWARD_ONLY LOCAL
            FOR SELECT c.[Name], 
                       TYPE_NAME(user_type_id), 
                       CONVERT(INT, max_length), 
                       [precision], 
                       scale,
                       CASE
                           WHEN is_nullable = 0
                           THEN ISNULL(' Constraint ' + QUOTENAME(d.[name]) + ' Default ' + d.[definition], '') + ' Not Null'
                           ELSE ' Null'
                       END, 
                       'Collation' = collation_name, 
                       is_nullable, 
                       d.[name], 
                       d.[definition]
                FROM sys.columns c
                     LEFT JOIN sys.default_constraints D ON c.[object_id] = d.parent_object_id
                                                            AND c.column_id = d.parent_column_id
                WHERE c.[object_id] = OBJECT_ID(@Table_Name)
                      AND (c.[name] = @Column
                           OR @Column IS NULL)
                      AND NOT c.[name] = @Column_PK
                ORDER BY c.column_id;
            OPEN Colunas_cursor;
            FETCH NEXT FROM Colunas_cursor INTO @Column_Name, @Type_Name, @Max_Length, @Precision, @Scale, @Is_Null, @Collation_Name, @Is_Nullable, @cnstname, @Definition;
            WHILE(@@Fetch_Status = 0)
                BEGIN
                    IF ISNULL(@Column_PK, '') <> @Column_Name
                        BEGIN
                            SET @Type_Aux = @Type_Name;
                            IF CHARINDEX(@Type_Name, @NumTypes) > 0
                                SET @Type_Aux = @Type_Aux + '(' + CONVERT(VARCHAR, @Precision) + ',' + CONVERT(VARCHAR, @Scale) + ')';
                                ELSE
                                IF CHARINDEX(@Type_Name, @StrTypes) > 0
                                    SET @Type_Aux = @Type_Aux + '(' + CONVERT(VARCHAR, Replace(@Max_Length, -1, 'Max')) + ')';
                            PRINT 'If Not Exists (Select 1 From sys.columns Where Name = ''' + @Column_Name + ''' And [object_Id] = Object_Id(''' + @Table_Name + '''))';
                            PRINT '    Alter Table [' + @Table_Name + '] Add [' + @Column_Name + '] ' + @Type_Aux + @Is_Null;
                            PRINT 'Else ';
                            PRINT '    If Not Exists(Select * From sys.columns c Where c.[object_id] = Object_Id(''' + @Table_Name + ''') And c.Name = ''' + @Column_Name + ''' And Type_Name(c.system_type_id) = ''' + @Type_Name + ''' And c.max_length = ' + CAST(@Max_Length AS VARCHAR) + ' And c.[precision] = ' + CAST(@Precision AS VARCHAR) + ' And c.scale = ' + CAST(@Scale AS VARCHAR) + ' /*And c.is_nullable = ' + CAST(@Is_Nullable AS VARCHAR) + '*/)';
                            IF @Is_Nullable = 1
                                PRINT '        Alter Table [' + @Table_Name + '] Alter Column [' + @Column_Name + '] ' + @Type_Aux + ' Null';
                                ELSE
                                BEGIN
                                    PRINT '        Begin';
                                    IF @cnstname IS NOT NULL
                                        BEGIN
                                            PRINT '             If Not Exists(Select * From sys.default_constraints dc Where dc.parent_object_id = Object_Id(''' + @Table_Name + ''') And Col_Name(Object_Id(''' + @Table_Name + '''), dc.parent_column_id) = ''' + @Column_Name + ''')';
                                            PRINT '                 Alter Table [' + @Table_Name + '] Add Constraint ' + @cnstname + ' Default ' + @Definition + ' For ' + @Column_Name;
                                    END;
                                    PRINT '            Alter Table [' + @Table_Name + '] Alter Column [' + @Column_Name + '] ' + @Type_Aux + ' Not Null';
                                    PRINT '        End';
                            END;
                            PRINT 'Go';
                    END;
                    FETCH NEXT FROM Colunas_cursor INTO @Column_Name, @Type_Name, @Max_Length, @Precision, @Scale, @Is_Null, @Collation_Name, @Is_Nullable, @cnstname, @Definition;
                END;
            CLOSE Colunas_cursor;
            DEALLOCATE Colunas_cursor;
            IF @Column IS NULL
               OR @Column_PK = @Column
                BEGIN
                    DECLARE ms_crs_cnst CURSOR LOCAL FAST_FORWARD
                    FOR SELECT O.[object_id], 
                               O.[type], 
                               O.[name]
                        FROM sys.objects O
                        WHERE O.parent_object_id = OBJECT_ID(@Table_Name)
                              AND O.[type] IN('PK')
                        ORDER BY O.[object_id];
                    OPEN ms_crs_cnst;
                    FETCH ms_crs_cnst INTO @cnstid, @cnsttype, @cnstname;
                    WHILE @@Fetch_Status >= 0
                        BEGIN
                            DECLARE @indid SMALLINT;
                            SELECT @indid = index_id
                            FROM sys.indexes
                            WHERE [object_id] = @ObjId
                                  AND [name] = OBJECT_NAME(@cnstid);
                            SET @keys = INDEX_COL(@Table_Name, @indid, 1);
                            PRINT 'If Not Exists(Select 1 From sys.key_constraints kc Where parent_object_id = Object_Id(''' + @Table_Name + ''') And kc.[type] = ''PK'')';
                            PRINT '    Alter Table ' + @Table_Name + ' Add Constraint ' + @cnstname + ' Primary Key (' + @keys + ')';
                            PRINT 'Go';
                            FETCH ms_crs_cnst INTO @cnstid, @cnsttype, @cnstname;
            END;
                    DEALLOCATE ms_crs_cnst;
            END;
            DECLARE @fkeyid INT, @rkeyid INT;
            PRINT '/' + REPLICATE('*', 54) + '/';
            PRINT '/' + REPLICATE('*', 20) + ' Foreign Keys ' + REPLICATE('*', 20) + '/';
            PRINT '/' + REPLICATE('*', 54) + '/' + CHAR(13) + CHAR(10) + CHAR(13) + CHAR(10);
            DECLARE ms_crs_cnst CURSOR LOCAL FAST_FORWARD
            FOR SELECT O.[object_id], 
                       O.[type], 
                       O.[name]
                FROM sys.objects O
                     INNER JOIN sys.foreign_key_columns R ON R.constraint_object_id = O.[object_id]
                WHERE O.parent_object_id = OBJECT_ID(@Table_Name)
                      AND (R.parent_column_id = @Column_Id
                           OR @Column_Id IS NULL)
                      AND O.[type] = 'F '
                ORDER BY r.parent_column_id;
            OPEN ms_crs_cnst;
            FETCH ms_crs_cnst INTO @cnstid, @cnsttype, @cnstname;
            WHILE @@Fetch_Status >= 0
                BEGIN
                    SELECT @fkeyid = parent_object_id, 
                           @rkeyid = referenced_object_id
                    FROM sys.foreign_keys
                    WHERE [object_id] = @cnstid;
                    DECLARE ms_crs_fkey CURSOR LOCAL FAST_FORWARD
                    FOR SELECT parent_column_id, 
                               referenced_column_id
                        FROM sys.foreign_key_columns
                        WHERE constraint_object_id = @cnstid
                        ORDER BY referenced_column_id;
                    OPEN ms_crs_fkey;
                    DECLARE @fkeycol SMALLINT, @rkeycol SMALLINT;
                    FETCH ms_crs_fkey INTO @fkeycol, @rkeycol;
                    SET @keys = COL_NAME(@fkeyid, @fkeycol);
                    SET @cnstdes = COL_NAME(@rkeyid, @rkeycol);
                    FETCH ms_crs_fkey INTO @fkeycol, @rkeycol;
                    WHILE @@Fetch_Status >= 0
                        BEGIN
                            SET @keys = @keys + ', ' + COL_NAME(@fkeyid, @fkeycol);
                            SET @cnstdes = @cnstdes + ', ' + COL_NAME(@rkeyid, @rkeycol);
                            FETCH ms_crs_fkey INTO @fkeycol, @rkeycol;
                        END;
                    DEALLOCATE ms_crs_fkey;
                    PRINT 'If Not Exists(Select 1 From sys.foreign_keys fk Where fk.parent_object_id = Object_Id(''' + @Table_Name + ''') And fk.name = ''' + @cnstname + ''')';
                    PRINT '    Alter Table [' + @Table_Name + '] Add Constraint [' + @cnstname + '] Foreign Key (' + @keys + ') References ' + OBJECT_NAME(@rkeyid) + ' (' + COL_NAME(@rkeyid, @rkeycol) + ')';
                    PRINT 'Go';
                    FETCH ms_crs_cnst INTO @cnstid, @cnsttype, @cnstname;
                END;
            DEALLOCATE ms_crs_cnst;
            PRINT '/' + REPLICATE('*', 15) + ' Check Constraints ' + REPLICATE('*', 15) + '*/';
            DECLARE ms_crs_cnst CURSOR LOCAL FAST_FORWARD
            FOR SELECT O.[object_id], 
                       O.[type], 
                       O.[name], 
                       C.[definition]
                FROM sys.objects O
                     INNER JOIN sys.check_constraints C ON C.[object_id] = O.[object_id]
                WHERE O.parent_object_id = OBJECT_ID(@Table_Name)
                      AND (C.parent_column_id = @Column_Id
                           OR @Column_Id IS NULL)
                      AND O.[type] = 'C '
                ORDER BY c.parent_column_id;
            OPEN ms_crs_cnst;
            FETCH ms_crs_cnst INTO @cnstid, @cnsttype, @cnstname, @Definition;
            WHILE @@Fetch_Status >= 0
                BEGIN
                    PRINT 'If Not Exists(Select 1 From sys.check_constraints ck Where ck.parent_object_id = Object_Id(''' + @Table_Name + ''') And ck.name = ''' + @cnstname + ''')';
                    PRINT '    Alter Table ' + @Table_Name + ' Add Constraint ' + @cnstname + ' Check ' + @Definition;
                    PRINT 'Go';
                    FETCH ms_crs_cnst INTO @cnstid, @cnsttype, @cnstname, @Definition;
                END;
            DEALLOCATE ms_crs_cnst;
            PRINT '/' + REPLICATE('*', 15) + ' Defaults ' + REPLICATE('*', 15) + '*/';
            DECLARE ms_crs_cnst CURSOR LOCAL
            FOR SELECT O.[object_id], 
                       O.[type], 
                       O.[name], 
                       D.[definition], 
                       COL_NAME(@ObjId, D.parent_column_id)
                FROM sys.objects O
                     INNER JOIN sys.default_constraints D ON D.[object_id] = O.[object_id]
                WHERE O.parent_object_id = OBJECT_ID(@Table_Name)
                      AND (D.parent_column_id = @Column_Id
                           OR @Column_Id IS NULL)
                      AND O.[type] = 'D '
                ORDER BY D.parent_column_id;
            OPEN ms_crs_cnst;
            FETCH ms_crs_cnst INTO @cnstid, @cnsttype, @cnstname, @Definition, @Column_Name;
            WHILE @@Fetch_Status >= 0
                BEGIN
                    PRINT 'If Not Exists(Select 1 From sys.default_constraints dc Inner Join sys.columns c on c.column_id = dc.parent_column_id And c.[object_id] = dc.parent_object_id Where dc.parent_object_id = Object_Id(''' + @Table_Name + ''') And c.name = ''' + @Column_Name + ''' And dc.[definition] = ''' + Replace(@Definition, '''', '''''') + ''')';
                    PRINT '    Alter Table ' + @Table_Name + ' Add Constraint ' + @cnstname + ' Default ' + @Definition + ' For ' + @Column_Name;
                    PRINT 'Go';
                    FETCH ms_crs_cnst INTO @cnstid, @cnsttype, @cnstname, @Definition, @Column_Name;
                END;
            DEALLOCATE ms_crs_cnst;
        END;
    GO;

    -- Create Function: Split_Xml
    SET ANSI_NULLS ON;
    SET QUOTED_IDENTIFIER ON;
    GO;
    IF OBJECT_ID('[dbo].[Split_Xml]', 'TF') IS NULL
        EXEC ('CREATE FUNCTION [dbo].[Split_Xml]() RETURNS @Results TABLE (Itens INT NULL) AS BEGIN RETURN; END');
    GO;
    ALTER FUNCTION [dbo].[Split_Xml](@Delimited NVARCHAR(MAX), 
                                     @Delimiter NVARCHAR(100))
    RETURNS @T TABLE
    (Id   INT IDENTITY(1, 1), 
     Item NVARCHAR(MAX)
    )
    AS
         BEGIN
             DECLARE @Xml XML;
             SET @Xml = N'<root><r>' + REPLACE(
             (
                 SELECT @Delimited AS [*] FOR XML PATH('')
             ),
             (
                 SELECT @Delimiter AS [*] FOR XML PATH('')
             ), '</r><r>') + '</r></root>';
             INSERT INTO @T(Item)
                    SELECT R.value('.', 'varchar(max)') AS Item
                    FROM @Xml.nodes('//root/r') AS Records(R);
             RETURN;
         END;
    GO;

    -- Create Function: udf_TitleCase
    SET ANSI_NULLS ON;
    SET QUOTED_IDENTIFIER ON;
    GO;
    IF OBJECT_ID('[dbo].[udf_TitleCase]', 'FN') IS NULL
        EXEC ('CREATE FUNCTION [dbo].[udf_TitleCase]() RETURNS INT AS BEGIN RETURN 0; END');
    GO;
    ALTER FUNCTION [dbo].[udf_TitleCase](@InputString VARCHAR(4000))
    RETURNS VARCHAR(4000)
    AS
         BEGIN
             DECLARE @Index INT;
             DECLARE @Char CHAR(1);
             DECLARE @OutputString VARCHAR(255);
             SET @OutputString = LOWER(@InputString);
             SET @Index = 2;
             SET @OutputString = STUFF(@OutputString, 1, 1, UPPER(SUBSTRING(@InputString, 1, 1)));
             WHILE @Index <= LEN(@InputString)
                 BEGIN
                     SET @Char = SUBSTRING(@InputString, @Index, 1);
                     IF @Char IN(' ', ';', ':', '!', '?', ',', '.', '_', '-', '/', '&', '''', '(')
                         IF @Index + 1 <= LEN(@InputString)
                             BEGIN
                                 IF @Char != ''''
                                    OR UPPER(SUBSTRING(@InputString, @Index + 1, 1)) != 'S'
                                     SET @OutputString = STUFF(@OutputString, @Index + 1, 1, UPPER(SUBSTRING(@InputString, @Index + 1, 1)));
                         END;
                     SET @Index = @Index + 1;
                 END;
             RETURN ISNULL(@OutputString, '');
         END;
    GO;
    SET ANSI_NULLS ON;
    SET QUOTED_IDENTIFIER ON;
    go;
    IF OBJECT_ID('[dbo].[usp_RegisterUser]', 'P') IS NULL
        EXEC ('Create Proc [dbo].[usp_RegisterUser] As Return 0;');
    go;
    ALTER PROCEDURE [dbo].[usp_RegisterUser] @name              VARCHAR(2000), 
                                             @email             VARCHAR(2000), 
                                             @passwordHash      VARCHAR(2000), 
                                             @tipoEmpresa       VARCHAR(2000), 
                                             @cnpj              VARCHAR(2000) = NULL, 
                                             @nomeFantasia      VARCHAR(2000) = NULL, 
                                             @razaoSocial       VARCHAR(2000) = NULL, 
                                             @cpf               VARCHAR(2000) = NULL, 
                                             @cep               VARCHAR(2000) = NULL, 
                                             @endereco          VARCHAR(2000) = NULL, 
                                             @numero            VARCHAR(2000) = NULL, 
                                             @complemento       VARCHAR(2000) = NULL, 
                                             @canCadastrarItem  BIT           = 0, 
                                             @canMinhaEmpresa   BIT           = 0, 
                                             @canGerenciarItens BIT           = 0
    AS
        BEGIN
            SET NOCOUNT ON;
            BEGIN TRY
                -- Check if email already exists
                IF EXISTS
                (
                    SELECT 1
                    FROM Users
                    WHERE email = @email
                )
                    BEGIN
                        SELECT 0 AS Success, 
                               NULL AS UserId, 
                               'E-mail já existe' AS Message;
                        RETURN;
                END;

                -- Validate based on tipoEmpresa (CPF or CNPJ) and check for duplicates
                IF @tipoEmpresa = 'CPF'
                    BEGIN
                        IF EXISTS
                        (
                            SELECT 1
                            FROM Users
                            WHERE cpf = @cpf
                                  AND cpf IS NOT NULL
                        )
                            BEGIN
                                SELECT 0 AS Success, 
                                       NULL AS UserId, 
                                       'CPF já existe' AS Message;
                                RETURN;
                        END;
                END;
                    ELSE
                    IF @tipoEmpresa = 'CNPJ'
                        BEGIN
                            IF EXISTS
                            (
                                SELECT 1
                                FROM Users
                                WHERE cnpj = @cnpj
                                      AND cnpj IS NOT NULL
                            )
                                BEGIN
                                    SELECT 0 AS Success, 
                                           NULL AS UserId, 
                                           'CNPJ já existe' AS Message;
                                    RETURN;
                            END;
                    END;

                -- Insert the new user if all checks pass
                INSERT INTO Users
                (email, 
                 password, 
                 name, 
                 tipoEmpresa, 
                 cpf, 
                 nomeFantasia, 
                 razaoSocial, 
                 cnpj, 
                 endereco, 
                 numero, 
                 complemento, 
                 canCadastrarItem, 
                 canMinhaEmpresa, 
                 canGerenciarItens, 
                 createdAt, 
                 updatedAt, 
                 status_id
                )
                VALUES
                (@email, 
                 @passwordHash, 
                 @name, 
                 @tipoEmpresa, 
                 @cpf, 
                 @nomeFantasia, 
                 @razaoSocial, 
                 @cnpj, 
                 @endereco, 
                 @numero, 
                 @complemento, 
                 @canCadastrarItem, 
                 @canMinhaEmpresa, 
                 @canGerenciarItens, 
                 GETDATE(), 
                 GETDATE(), 
                 1
                );

                -- Return success with the inserted UserId
                SELECT 1 AS Success, 
                       SCOPE_IDENTITY() AS UserId, 
                       'Usuário cadastrado com sucesso' AS Message;
            END TRY
            BEGIN CATCH
                SELECT 0 AS Success, 
                       NULL AS UserId, 
                       'Erro interno ao processar o registro' AS Message;
            END CATCH;
        END;
    go;
    COMMIT TRANSACTION;
END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK TRANSACTION;
    DECLARE @ErrorMessage NVARCHAR(4000)= ERROR_MESSAGE();
    DECLARE @ErrorSeverity INT= ERROR_SEVERITY();
    DECLARE @ErrorState INT= ERROR_STATE();
    RAISERROR(@ErrorMessage, @ErrorSeverity, @ErrorState);
END CATCH;